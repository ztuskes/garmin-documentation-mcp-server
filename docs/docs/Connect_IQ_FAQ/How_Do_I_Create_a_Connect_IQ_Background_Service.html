<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2025"><meta name="DC.rights.owner" content="(C) Copyright 2025"><meta name="DC.type" content="topic"><meta name="DC.format" content="HTML5"><meta name="DC.identifier" content="how-do-i-create-a-connect-iq-background-service"><link rel="stylesheet" type="text/css" href="../../branding/commonltr.css"><link rel="stylesheet" type="text/css" href="../../branding/style.css"><title>How do I create a Connect IQ Background Service?</title></head><body id="how-do-i-create-a-connect-iq-background-service"><header role="banner"><div>
<link href="../../resources/programmers-guide/google-code-prettify/prettify.css" type="text/css" rel="stylesheet">
<script src="../../resources/programmers-guide/jquery-1.11.3.min.js"></script>
<script>
    $(document).ready( function() {
        $( 'pre' ).addClass( 'prettyprint' );
    } );
</script>
<script src="../../resources/programmers-guide/google-code-prettify/run_prettify.js"></script>
</div></header><nav role="toc"><ul><li><a href="../../docs/Readme/Intro.html">Introduction</a></li><li><a href="../../docs/Connect_IQ_Basics/Welcome_to_the_Jungle.html">Welcome to Connect IQ</a></li><li><a href="../../docs/Monkey_C/Basic_Syntax.html">Hello Monkey C!</a></li><li><a href="../../docs/Core_Topics/Overview.html">Core Topics</a></li><li><a href="../../docs/User_Experience_Guidelines/Overview.html">User Experience Guidelines</a></li><li><a href="../../docs/Personality_Library/Personality_UI.html">Personality UI</a></li><li><a href="../../docs/Connect_IQ_FAQ/Overview.html">Connect IQ FAQ</a><ul><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Get_My_Watch_Face_to_Update_Every_Second.html">How do I Make My Watch Face Update Every Second?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Use_REST_Services.html">How do I communicate with REST services?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Make_a_Watch_Face_for_AMOLED_Products.html">How do I Make a Watch Face for AMOLED Products?</a></li><li class="active"><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Create_a_Connect_IQ_Background_Service.html">How do I create a Connect IQ Background Service?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Optimize_Bitmaps.html">How do I optimize bitmaps in my app?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Override_the_Goal_Animations.html">How do I Override The Goal Animation?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Use_Custom_Fonts.html">How do I use custom fonts?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Use_a_Mapview.html">How do I use a MapView?</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Use_the_Connect_IQ_Mobile_SDK.html">How do I use the Connect IQ Mobile SDK</a></li><li><a href="../../docs/Connect_IQ_FAQ/How_Do_I_Create_an_Audio_Content_Provider.html">How do I create an Audio Content Provider?</a></li></ul></li><li><a href="../../docs/Reference_Guides/Overview.html">Reference Guides</a></li><li><a href="../../docs/App_Review_Guidelines/Overview.html">Garmin Connect IQ App Review Guidelines</a></li><li><a href="../../docs/Monetization/Overview.html">Connect IQ Monetization System</a></li><li><a href="../../docs/Device_Reference/Overview.html">Device Reference</a></li></ul></nav><main role="main"><article role="article" aria-labelledby="ariaid-title1"><h1 class="title topictitle1" id="ariaid-title1">How do I create a Connect IQ Background Service?</h1><div class="body"><p class="p"><em class="ph i">This post was written by Jim Miller, a Connect IQ developer in Phoenix, AZ.</em></p><p class="p">One of the new features in API level 2.3.0 is <em class="ph i">background services</em>, or the ability for a Connect IQ application to have a service that runs even if the main application isn't running. Background services have different abilities than the main process; a watch face or data field that can't do communications itself, but the background process can! The most common example of this right now is a watch face that displays weather information from the internet. When something happens in the background, that process can optionally prompt the user if they want to start the main application, or the background can just collect data for the next time the main application runs.</p><p class="p">I'll be talking about background services that take advantage of temporal events. In simple terms, it's a process that's time driven: it runs every "x" minutes, or can be set to run at a certain time. Temporal events can fire at most every 5 minutes, and will run at most 30 seconds each time it runs. The focus here will be on background processes that don't try to start the main app when something happens, but just collect data for the main process.</p><p class="p">I've created a very basic watch face with a background service on the <a class="xref" href="https://forums.garmin.com/developer/connect-iq/f/discussion/5287/very-simple-sample-of-a-watch-face-with-a-background-process" target="_blank">developer forum</a> and <a class="xref" href="https://forums.garmin.com/cfs-file/__key/communityserver-discussions-components-files/12/7750.vsbgwf.zip" target="_blank">included a .zip</a> of the project in the first post so you can see the code and try it out yourself. The watch face itself displays the time, and the last data seen from the background service (plus a counter, etc). And all the background does is return a string with an "hh:mm" timestamp. While it isn't useful, it does show the basics of backgrounding with a temporal event. In this case, there's really isn't much in the <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/WatchUi/View.html" target="_blank">View</a> class, but the things to look at are in App class and the file with the background process - the <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/System/ServiceDelegate.html" target="_blank">ServiceDelegate</a>.</p><p class="p">When doing an app with backgrounding, there are a few things that come into play. In the sample project, you'll see how these pieces all fit together.</p></div><article class="topic nested1" aria-labelledby="ariaid-title2" id="the-background-annotation"><h2 class="title topictitle2" id="ariaid-title2">The Background Annotation</h2><div class="body"><p class="p">To save memory, each time the background service runs only the necessary code is loaded. Background services have a 32 KB heap, so things can get tight! The (:background) annotation is used to indicate what classes, modules, and variables need to be available when the background service runs. The main <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html" target="_blank">App</a> class is loaded by default, but you want to use the annotation on things like the <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/System/ServiceDelegate.html" target="_blank">ServiceDelegate</a> and any things it may use or reference.</p><pre class="pre codeblock typescript"><code>(:background)
class BgbgServiceDelegate extends Toybox.System.ServiceDelegate {</code></pre><p class="p">Using it doesn't mean that it's only in the background service; classes, modules, and variables will be available in both the main process and background process.</p></div></article><article class="topic nested1" aria-labelledby="ariaid-title3" id="service-delegate"><h2 class="title topictitle2" id="ariaid-title3">Service Delegate</h2><div class="body"><p class="p">A background service can be triggered by different kinds of system events: step goal achievement, sleep/wake times, and temporal events, which are discussed below. The <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/System/ServiceDelegate.html" target="_blank">System.ServiceDelegate</a> allows you to define what your app should execute when these events occur. The <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#getServiceDelegate-instance_function" target="_blank">AppBase.getServiceDelegate()</a> is how the service delegate in your code is found. Use the methods in the <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Background.html" target="_blank">Toybox.Background</a> module to register your service to fire on given triggers.</p></div></article><article class="topic nested1" aria-labelledby="ariaid-title4" id="temporal-events"><h2 class="title topictitle2" id="ariaid-title4">Temporal Events</h2><div class="body"><p class="p"><a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Background.html#registerForTemporalEvent-instance_function" target="_blank">Background.registerForTemporalEvents()</a> is used to set how often the background temporal event runs. In the sample code, I do it as part of <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#getInitialView-instance_function" target="_blank">AppBase.getInitialView()</a> after doing a check to make sure the app is running on a device that supports backgrounding.</p><pre class="pre codeblock typescript"><code>        //register for temporal events if they are supported
        if(Toybox.System has :ServiceDelegate) {
            canDoBG=true;
            Background.registerForTemporalEvent(new Time.Duration(5 * 60));
        } else {
            Sys.println("****background not available on this device****");
        }</code></pre><p class="p"><a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Background.html#deleteTemporalEvent-instance_function" target="_blank">Background.deleteTemporalEvent()</a> can turn off the background process if desired. With a combination of those calls, you can get a bit of control over when a temporal event runs. For example, you can do things like not starting the temporal event until there is a connection to a phone, deleting the temporal event when your app no longer needs it, etc. Note: Normally when you have started a temporal event process, it will run even when the parent app isn't running. With watch faces only the temporal event for the currently selected watch face will run.</p><p class="p">With some temporal events, you may want to pass an error status back to the main process instead of data. A good example of this would be a background service that does communications. In many cases, you will be passing back the data you received (I often just pass back the dictionary from the callback), but in the case of an error, I just pass back a Number representing the error. Then in <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#onBackgroundData-instance_function" target="_blank">AppBase.onBackgroundData()</a>, I use instanceof Number to check if I got data or an error, and handle the error or data as needed. Here's a simple example of that:</p><pre class="pre codeblock typescript"><code>function onBackgroundData(data) {
    if(data instanceof Number) {
        //indicates there was an error, and "data" is the error code
    } else {
        //got good "data"
    }
}</code></pre></div></article><article class="topic nested1" aria-labelledby="ariaid-title5" id="interprocess-communication"><h2 class="title topictitle2" id="ariaid-title5">Interprocess Communication</h2><div class="body"><p class="p">You pass data from your background service to the main process using <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Background.html#exit-instance_function" target="_blank">Background.exit()</a> in your <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/System/ServiceDelegate.html" target="_blank">ServiceDelegate</a></p><pre class="pre codeblock typescript"><code>    function onTemporalEvent() {
        var now=Sys.getClockTime();
        var ts=now.hour+":"+now.min.format("d");
        Sys.println("bg exit: "+ts);
        //just return the timestamp
        Background.exit(ts);
    }</code></pre><p class="p"><a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#onBackgroundData-instance_function" target="_blank">AppBase.onBackgroundData()</a> is how the main process gets the latest data from what the service returned by <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Background.html#exit-instance_function" target="_blank">Background.exit()</a>. In the main process, when it first starts, I'll see if data is in the object store, and if so, then you display that as a "last known value". If you don't do something like this with a watch face, each time you leave the watch face and come back, there wouldn't be any data until the background runs again.</p><pre class="pre codeblock typescript"><code>    function onBackgroundData(data) {
        $.counter++;
        var now=Sys.getClockTime();
        var ts=now.hour+":"+now.min.format("d");
        Sys.println("onBackgroundData="+data+" "+counter+" at "+ts);
        bgdata=data;
        App.getApp().setProperty(OSDATA,bgdata);
        Ui.requestUpdate();
}</code></pre><p class="p">You can't use <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#setProperty-instance_function" target="_blank">AppBase.setProperty()</a> in the background process to pass data in the object store or settings; if you try, an exception is thrown. You also can't pass information between the main process and the background with global variables. The word "process" is important here: global variables are per process, so the same global is only global for that process. A variable defined globally exists in both the main process and background process, but each maintains its own copy and they're never synced.. That been said, the only way to pass data from the main app to the background service is as a property. Your <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/System/ServiceDelegate.html" target="_blank">ServiceDelegate</a> can retrieve it with <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#getProperty-instance_function" target="_blank">AppBase.getProperty()</a>. It can be something in the object store or from settings. Make sure to handle the case where the background may not have the data it needs here, as there are things that may not yet have valid values.</p><p class="p">The background can run more than once before the main process sees it in <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Application/AppBase.html#onBackgroundData-instance_function" target="_blank">AppBase.onBackgroundData()</a>. The main process only sees the last one, not all of them, but in the background process you can use <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Background.html#getBackgroundData-instance_function" target="_blank">Background.getBackgroundData()</a> to get what's currently queued for the main process, but not yet delivered. You can combine that with what the background process has that's new, and return it all.</p></div></article><article class="topic nested1" aria-labelledby="ariaid-title6" id="other-points"><h2 class="title topictitle2" id="ariaid-title6">Other Points</h2><div class="body"><ul class="ul"><li class="li"><p class="p"><strong class="ph b">Watch Faces</strong> - Watch faces are a bit different than other app times when it comes to if/when a background service runs, and this is by design. The background service for a watch face will only be run if that watch face is the "active" watch face (the one currently selected to be used). Think of the case where you have two watch faces installed, that both get weather data from the same source, with a limit on requests per day. There's no reason for the background service for the non-active watch face to run, as it would just use up the quota of requests per day.</p></li><li class="li"><p class="p"><strong class="ph b">Size of response to makeWebRequest() calls</strong> - If you are doing <a class="xref" href="https://developer.garmin.com/connect-iq/api-docs/Toybox/Communications.html#makeWebRequest-instance_function" target="_blank">Communications.makeWebRequest()</a> calls in your background process, one thing to keep in mind is the size of the response you get back. The background process has limited memory. When a response is received, there must be enough memory to contain both the response and to build the dictionary passed back to your callback.</p></li><li class="li"><p class="p"><strong class="ph b">Notes about the Simulator:</strong> - You can test backgrounding in the simulator. In the case of temporal events, they will occur as scheduled, but under the "Simulation" menu, you can trigger the background process to run.</p></li></ul><p class="p">There is a known issue with the simulator with background apps: the simulator will run the background services of apps you've tested in it, even if it isn't the "active" app being tested. So if you are testing "app a" and then switch to "app b", the background for "app a" will run as well as the background for "app b". Even if your current target doesn't have a background service the simulator may attempt to start it. The Connect IQ team is aware of the issue and will address it in a upcoming release</p><p class="p">As you can see, background services are a powerful new addition to the Connect IQ toy box. They allow your app to periodically poll the internet for information, including watch faces and data fields. What can you use them for?</p><p class="p"><strong class="ph b">About The Author</strong> <em class="ph i">Jim Miller is a Connect IQ developer in Arizona. "In early 2015, I had a forerunner 15, and liked the GPS and step tracking. Then the original vívoactive was announced, and I pre-ordered it, and downloaded the CIQ 1.0.0 SDK the same week!" You can see his</em> <a class="xref" href="https://apps.garmin.com/en-US/developer/b73df9e6-4021-4059-b2e8-f9cfa04947c3/apps" target="_blank"><em class="ph i">apps on the app store</em></a> <em class="ph i">and find him on</em> <a class="xref" href="https://www.instagram.com/jim.m.58/" target="_blank"><em class="ph i">Instagram</em></a><em class="ph i">, his</em> <a class="xref" href="https://www.facebook.com/connectiqaz" target="_blank"><em class="ph i">Connect IQ Facebook Page</em></a><em class="ph i">, or on the</em> <a class="xref" href="https://forums.garmin.com/member/313012-jim_m_58" target="_blank"><em class="ph i">Connect IQ forums</em></a><em class="ph i">.</em></p></div></article></article></main><footer role="contentinfo"><div>
<p class="disclaimer">
Connect IQ System None API 8.2.3 Documentation. Copyright 2025 Garmin International. All Rights Reserved.
</p>
</div></footer></body></html>